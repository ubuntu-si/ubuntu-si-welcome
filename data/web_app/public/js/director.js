(function(){function t(e,n){if("function"==typeof e)return t("*",e);if("function"==typeof n)for(var r=new i(e),a=1;arguments.length>a;++a)t.callbacks.push(r.middleware(arguments[a]));else"string"==typeof e?t.show(e,n):t.start(e)}function e(e){window.location.pathname+window.location.search!=e.canonicalPath&&(t.stop(),e.unhandled=!0,window.location=e.canonicalPath)}function n(t,e){"/"==t[0]&&0!=t.indexOf(p)&&(t=p+t);var n=t.indexOf("?");this.canonicalPath=t,this.path=t.replace(p,"")||"/",this.title=document.title,this.state=e||{},this.state.path=t,this.querystring=~n?t.slice(n+1):"",this.pathname=~n?t.slice(0,n):t,this.params=[]}function i(t,e){e=e||{},this.path=t,this.method="GET",this.regexp=r(t,this.keys=[],e.sensitive,e.strict)}function r(t,e,n,i){return t instanceof RegExp?t:(t instanceof Array&&(t="("+t.join("|")+")"),t=t.concat(i?"":"/?").replace(/\/\(/g,"(?:/").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(t,n,i,r,a,s){return e.push({name:r,optional:!!s}),n=n||"",""+(s?"":n)+"(?:"+(s?n:"")+(i||"")+(a||i&&"([^/.]+?)"||"([^/]+?)")+")"+(s||"")}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)"),RegExp("^"+t+"$",n?"":"i"))}function a(e){if(e.state){var n=e.state.path;t.replace(n,e.state)}}function s(e){if(1==o(e)&&!e.defaultPrevented){for(var n=e.target;n&&"A"!=n.nodeName;)n=n.parentNode;if(n&&"A"==n.nodeName){var i=n.href,r=n.pathname+n.search;if(!n.hash&&"#"!=n.getAttribute("href")&&c(i)){var a=r;r=r.replace(p,""),p&&a==r||(e.preventDefault(),t.show(a))}}}}function o(t){return t=t||window.event,null==t.which?t.button:t.which}function c(t){var e=location.protocol+"//"+location.hostname;return location.port&&(e+=":"+location.port),0==t.indexOf(e)}var u,h=!0,p="";t.callbacks=[],t.base=function(t){return 0==arguments.length?p:(p=t,void 0)},t.start=function(e){e=e||{},u||(u=!0,!1===e.dispatch&&(h=!1),!1!==e.popstate&&window.addEventListener("popstate",a,!1),!1!==e.click&&window.addEventListener("click",s,!1),h&&t.replace(location.pathname+location.search,null,!0,h))},t.stop=function(){u=!1,removeEventListener("click",s,!1),removeEventListener("popstate",a,!1)},t.show=function(e,i){var r=new n(e,i);return t.dispatch(r),r.unhandled||r.pushState(),r},t.replace=function(e,i,r,a){var s=new n(e,i);return s.init=r,null==a&&(a=!0),a&&t.dispatch(s),s.save(),s},t.dispatch=function(n){function i(){var a=t.callbacks[r++];return a?(a(n,i),void 0):e(n)}var r=0;i()},t.Context=n,n.prototype.pushState=function(){history.pushState(this.state,this.title,this.canonicalPath)},n.prototype.save=function(){history.replaceState(this.state,this.title,this.canonicalPath)},t.Route=i,i.prototype.middleware=function(t){var e=this;return function(n,i){return e.match(n.path,n.params)?t(n,i):(i(),void 0)}},i.prototype.match=function(t,e){var n=this.keys,i=t.indexOf("?"),r=~i?t.slice(0,i):t,a=this.regexp.exec(r);if(!a)return!1;for(var s=1,o=a.length;o>s;++s){var c=n[s-1],u="string"==typeof a[s]?decodeURIComponent(a[s]):a[s];c?e[c.name]=void 0!==e[c.name]?e[c.name]:u:e.push(u)}return!0},"undefined"==typeof module?window.page=t:module.exports=t})();